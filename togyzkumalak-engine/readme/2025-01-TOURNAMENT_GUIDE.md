# Руководство по проведению турнира AlphaZero "Все против всех"

Этот документ описывает процесс организации кругового турнира между всеми сохраненными чекпоинтами (моделями) для выявления сильнейшей версии.

---

## 1. Подготовка удаленного сервера

Перед запуском турнира необходимо остановить текущее обучение и освободить видеопамять (VRAM).

1. **Остановка процессов:**
   ```bash
   fuser -k 8000/tcp   # Убить процесс на порту 8000
   pkill -9 python     # Принудительно завершить все процессы Python
   ```

2. **Проверка GPU:**
   Убедитесь, что `Memory-Usage` близок к 0 MiB:
   ```bash
   nvidia-smi
   ```

---

## 2. Подготовка чекпоинтов

Для корректной работы турнира все файлы должны лежать в папке:
`/workspace/togyzkumalak-engine/togyzkumalak-engine/models/alphazero/`

### Добавление локальных моделей:
Если у вас скопились модели на локальном компьютере, их нужно загрузить на сервер.
1. **Переименование:** Чтобы не затереть серверные файлы, добавьте префикс `local_` ко всем локальным файлам (например, `local_checkpoint_5.pth.tar`).
2. **Загрузка:** Самый простой способ — отправить их в Git-репозиторий и сделать `git pull` на сервере.

```bash
# На сервере для обновления кода и моделей:
cd /workspace/togyzkumalak-engine/togyzkumalak-engine
git reset --hard origin/master
git pull origin master
```

---

## 3. Запуск сервера и турнира

Турнир запускается через API-запрос к работающему бэкенду.

1. **Запуск бэкенда в фоне:**
   ```bash
   python run.py > server.log 2> server_error.log &
   ```

2. **Запуск турнира:**
   Отправьте POST-запрос. Параметр `num_games` определяет количество игр в каждой паре (например, 20 игр: 10 за белых, 10 за черных).
   ```bash
   curl -X POST "http://localhost:8000/api/training/alphazero/tournament/start?num_games=20"
   ```

---

## 4. Мониторинг

### Вариант А: Красивый UI (Dashboard)
Запустите скрипт монитора (локально или на сервере):
```bash
python deploy/monitor.py
```
*В мониторе появится раздел **Tournament Leaderboard** с очками (победа = 1.0, ничья = 0.5).*

### Вариант Б: Логи в реальном времени
```bash
tail -f alphazero_training.log
```

---

## 5. Завершение и выбор чемпиона

По окончании турнира в логах будет выведена итоговая таблица. Результаты также сохраняются в файл:
`models/alphazero/tournament_results.json`

### Как зафиксировать победителя:
Найдите лучшую модель и переименуйте её через API, чтобы использовать как базу для дальнейшего обучения:
```bash
# Пример для checkpoint_local_26.pth.tar
curl -X POST "http://localhost:8000/api/training/alphazero/checkpoints/checkpoint_local_26.pth.tar/rename?new_name=verified_champion_v1.pth.tar"
```

После этого вы можете запустить новое обучение, указав `verified_champion_v1.pth.tar` в качестве стартового чекпоинта.

---

## Технические детали кода
* **MCTS:** Турнир использует 60 симуляций MCTS на ход (режим Blitz).
* **Параллелизм:** Код автоматически распределяет матчи по всем доступным GPU (например, 4x RTX 4080) и использует все ядра CPU для логики игры.
